<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Bakery Cost Estimator</title>

    <link rel="manifest" href="manifest.json" />

    <link rel="apple-touch-icon" href="icon-192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#0f172a" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"
    ></script>

    <style>
      .scroller {
        -webkit-overflow-scrolling: touch;
      }
      [x-cloak] {
        display: none !important;
      }
      /* Hide arrows in number inputs */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }

      /* Toast Animation */
      .toast-enter {
        opacity: 0;
        transform: translateY(100%);
      }
      .toast-enter-active {
        opacity: 1;
        transform: translateY(0);
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .toast-exit {
        opacity: 1;
        transform: translateY(0);
      }
      .toast-exit-active {
        opacity: 0;
        transform: translateY(100%);
        transition: all 0.3s ease-in;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800 font-sans antialiased">
    <div
      x-data="bakeryApp()"
      x-init="initApp()"
      class="max-w-3xl mx-auto min-h-screen flex flex-col relative"
    >
      <header
        class="p-4 mb-2 flex justify-between items-center sticky top-0 bg-slate-50/95 backdrop-blur z-20"
      >
        <div class="flex-grow mr-4">
          <input
            type="text"
            x-show="view === 'calculator'"
            x-model="currentRecipeName"
            placeholder="Název Receptu..."
            class="w-full bg-transparent text-2xl sm:text-3xl font-bold text-slate-900 placeholder-slate-300 border-none outline-none focus:ring-0 p-0"
          />
          <h1
            x-show="view === 'ingredients'"
            class="text-3xl font-bold text-slate-900"
          >
            Sklad
          </h1>
        </div>

        <button
          @click="view = (view === 'calculator' ? 'ingredients' : 'calculator')"
          class="px-4 py-2 rounded-lg font-bold text-sm transition flex items-center gap-2 flex-shrink-0"
          :class="view === 'ingredients' ? 'bg-slate-800 text-white' : 'bg-white text-slate-600 shadow-sm border border-slate-200'"
        >
          <span x-text="view === 'calculator' ? 'Sklad' : 'Zpět'"></span>
          <svg
            x-show="view === 'calculator'"
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"
            />
          </svg>
        </button>
      </header>

      <div
        x-show="view === 'calculator'"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 translate-y-4"
        class="flex flex-col flex-grow px-4"
      >
        <section class="mb-4 flex gap-2">
          <button
            @click="saveRecipe()"
            class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-sm flex-1 sm:flex-none"
          >
            Uložit
          </button>
          <button
            @click="showRecipeList = true"
            class="bg-white text-blue-700 border border-blue-200 px-4 py-3 rounded-xl font-bold hover:bg-blue-50 transition shadow-sm flex items-center justify-center gap-2 flex-1 sm:flex-none"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
              />
            </svg>
            <span x-text="'Moje (' + savedRecipes.length + ')'"></span>
          </button>
        </section>

        <section
          class="flex-grow bg-white rounded-xl shadow-sm border border-slate-200 mb-4 pb-32"
        >
          <div
            class="hidden md:grid grid-cols-[1fr_auto_100px_50px] gap-4 p-4 bg-slate-100 border-b border-slate-200 text-slate-600 uppercase text-xs font-bold rounded-t-xl"
          >
            <div>Surovina</div>
            <div>Množství</div>
            <div class="text-right">Cena</div>
            <div></div>
          </div>

          <div class="divide-y divide-slate-100 relative">
            <div
              x-show="recipe.length === 0"
              class="p-12 text-center text-slate-400 italic"
            >
              Začněte přidáním první suroviny.
            </div>

            <template
              x-for="(row, index) in recipe"
              :key="row.id + '_' + index"
            >
              <div
                class="p-4 hover:bg-slate-50 transition group flex flex-col md:grid md:grid-cols-[1fr_auto_100px_50px] md:items-center gap-2 md:gap-4"
              >
                <div
                  class="font-bold text-slate-800 text-lg md:text-base leading-tight"
                  x-text="row.name"
                ></div>

                <div class="flex items-center justify-between md:contents">
                  <div class="flex items-center">
                    <button
                      @click="openNumpad(index)"
                      class="w-20 p-2 border border-slate-300 rounded-lg text-center font-mono text-lg font-bold text-slate-800 bg-white hover:border-blue-500 hover:text-blue-600 focus:ring-2 focus:ring-blue-100 transition"
                    >
                      <span x-text="row.quantity || '0'"></span>
                    </button>
                    <span
                      class="ml-2 text-slate-500 text-sm font-bold"
                      x-text="row.unit"
                    ></span>
                  </div>

                  <div
                    class="font-mono font-bold text-slate-700 text-right md:text-right"
                  >
                    <span
                      x-text="formatCurrency(row.quantity * row.price_per_unit)"
                    ></span>
                  </div>

                  <div class="text-right">
                    <button
                      @click="removeRow(index)"
                      class="text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition p-2"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"
                        />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </template>

            <div class="p-2 bg-slate-50/50 rounded-b-xl">
              <button
                @click="startSearch()"
                class="w-full py-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 transition flex items-center justify-center gap-2 group"
              >
                <div
                  class="bg-slate-200 text-slate-500 rounded-full p-1 group-hover:bg-blue-200 group-hover:text-blue-600 transition"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
                <span>Přidat surovinu</span>
              </button>
            </div>
          </div>
        </section>

        <footer
          class="fixed bottom-0 left-0 right-0 bg-slate-900 text-white z-[40] shadow-[0_-5px_15px_rgba(0,0,0,0.1)] md:absolute md:bottom-6 md:left-4 md:right-4 md:rounded-2xl md:max-w-3xl md:mx-auto"
        >
          <div class="md:hidden flex justify-between items-center p-4">
            <div class="flex flex-col">
              <span class="text-xs text-slate-400 uppercase tracking-wider"
                >Cena celkem</span
              >
              <span
                class="text-xl font-mono font-bold"
                x-text="formatCurrency(totalBatchCost)"
              ></span>
            </div>

            <div
              class="flex items-center gap-3 bg-slate-800 rounded-lg p-1.5 pl-3"
            >
              <div class="flex flex-col text-right">
                <span class="text-[10px] text-slate-400">ks</span>
                <span
                  class="text-xs font-bold text-blue-300"
                  x-text="formatCurrency(pricePerPortion)"
                ></span>
              </div>
              <input
                type="number"
                inputmode="numeric"
                x-model.number="portionCount"
                class="w-12 h-10 bg-slate-700 rounded text-center text-white font-mono font-bold focus:border-blue-400 border border-transparent outline-none"
              />
            </div>
          </div>

          <div class="hidden md:grid grid-cols-2 gap-6 items-center p-6">
            <div
              class="flex justify-between items-center border-r border-slate-700 pr-6"
            >
              <span class="text-slate-400 uppercase text-sm tracking-wider"
                >Cena za várku</span
              >
              <span
                class="text-2xl font-mono font-bold"
                x-text="formatCurrency(totalBatchCost)"
              ></span>
            </div>

            <div class="flex flex-col gap-4">
              <div class="flex justify-between items-center">
                <label class="text-slate-400 text-sm">Počet kusů</label>
                <input
                  type="number"
                  inputmode="numeric"
                  x-model.number="portionCount"
                  class="w-20 bg-slate-800 border border-slate-600 rounded-lg text-center text-white p-2 font-mono focus:border-blue-400 outline-none"
                />
              </div>
              <div
                class="flex justify-between items-center bg-blue-600 -mx-2 p-4 rounded-xl"
              >
                <span class="font-bold text-blue-100">Cena za 1 ks</span>
                <span
                  class="text-3xl font-bold font-mono"
                  x-text="formatCurrency(pricePerPortion)"
                ></span>
              </div>
            </div>
          </div>
        </footer>
      </div>

      <div
        x-show="view === 'ingredients'"
        x-cloak
        x-transition:enter="transition ease-out duration-200"
        class="flex-grow flex flex-col px-4"
      >
        <div class="mb-4 flex gap-2">
          <input
            type="text"
            x-model="managerSearch"
            placeholder="Hledat pro úpravu..."
            class="flex-grow p-3 border border-slate-300 rounded-xl shadow-sm focus:border-blue-500 outline-none"
          />
          <button
            @click="downloadJson()"
            class="bg-slate-200 text-slate-700 px-4 rounded-xl font-bold hover:bg-slate-300 transition"
            title="Stáhnout změny"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
              />
            </svg>
          </button>
          <button
            @click="resetToDefaults()"
            class="bg-red-100 text-red-700 px-4 rounded-xl font-bold hover:bg-red-200 transition"
            title="Obnovit výchozí"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              />
            </svg>
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-24">
          <template x-for="item in filteredIngredients" :key="item.id">
            <div
              class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm relative group"
            >
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h3
                    class="font-bold text-lg text-slate-800 leading-tight"
                    x-text="item.name"
                  ></h3>
                  <span
                    class="text-xs font-bold uppercase tracking-wider text-slate-400"
                    x-text="item.category"
                  ></span>
                </div>
                <div
                  class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-bold font-mono border border-blue-100 whitespace-nowrap"
                >
                  <span x-text="getBenchmarkPrice(item)"></span>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-bold text-slate-400 mb-1"
                    >Cena balení</label
                  >
                  <div class="relative">
                    <input
                      type="number"
                      inputmode="decimal"
                      step="0.1"
                      x-model.number="item.package_price"
                      @input="updateItemDetails(item, 'package_price', $el.value)"
                      class="w-full pl-2 pr-8 py-2 bg-slate-50 border border-slate-200 rounded-lg font-mono font-bold text-slate-700 focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition"
                    />
                    <span class="absolute right-3 top-2 text-slate-400 text-sm"
                      >Kč</span
                    >
                  </div>
                </div>

                <div>
                  <label class="block text-xs font-bold text-slate-400 mb-1"
                    >Velikost</label
                  >
                  <div class="flex rounded-lg shadow-sm">
                    <input
                      type="number"
                      inputmode="decimal"
                      step="any"
                      :value="parseFloat(item.package_size)"
                      @input="updateItemDetails(item, 'package_size_val', $el.value)"
                      class="w-full min-w-0 px-2 py-2 bg-slate-50 border border-slate-200 rounded-l-lg font-mono text-slate-700 focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition z-10"
                    />
                    <select
                      x-model="item.unit"
                      @change="updateItemDetails(item, 'unit', $el.value)"
                      class="bg-slate-100 text-slate-700 hover:bg-slate-200 border-y border-r border-slate-200 rounded-r-lg px-2 text-sm font-bold outline-none cursor-pointer transition"
                    >
                      <option value="g">g</option>
                      <option value="ml">ml</option>
                      <option value="ks">ks</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <div
        x-show="showRecipeList"
        x-cloak
        class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm"
      >
        <div
          @click.away="showRecipeList = false"
          class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]"
        >
          <div
            class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50"
          >
            <h2 class="text-xl font-bold text-slate-800">Uložené recepty</h2>
            <button
              @click="showRecipeList = false"
              class="text-slate-400 hover:text-slate-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <div class="overflow-y-auto p-4 scroller">
            <div
              x-show="savedRecipes.length === 0"
              class="text-center py-12 text-slate-400"
            >
              <p class="italic">Zatím nemáte žádné uložené recepty.</p>
            </div>

            <div class="space-y-3">
              <template x-for="(saved, index) in savedRecipes" :key="saved.id">
                <div
                  class="flex items-center justify-between p-4 border border-slate-200 rounded-xl hover:border-blue-300 transition group bg-white"
                >
                  <div>
                    <h3
                      class="font-bold text-lg text-slate-800"
                      x-text="saved.name"
                    ></h3>
                    <p
                      class="text-xs text-slate-400"
                      x-text="'Položek: ' + saved.items.length"
                    ></p>
                  </div>
                  <div class="flex items-center gap-2">
                    <button
                      @click="loadRecipe(saved)"
                      class="bg-blue-100 text-blue-700 px-3 py-2 rounded-lg font-bold text-sm hover:bg-blue-200 transition"
                    >
                      Načíst
                    </button>
                    <button
                      @click="deleteRecipe(index)"
                      class="text-slate-300 hover:text-red-500 p-2 transition"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                        />
                      </svg>
                    </button>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <div
        x-show="searchOpen"
        x-cloak
        class="fixed inset-0 z-[200] bg-white flex flex-col"
      >
        <div class="p-4 border-b border-slate-200 flex items-center gap-3">
          <div class="relative flex-grow">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
            <input
              x-ref="searchInput"
              type="text"
              x-model="searchQuery"
              @input="performSearch()"
              @keydown.escape="cancelSearch()"
              @keydown.enter.prevent="selectTopResult()"
              placeholder="Hledat surovinu..."
              class="w-full pl-10 pr-4 py-3 bg-slate-100 border-none rounded-xl text-lg font-bold text-slate-800 placeholder-slate-400 outline-none focus:ring-2 focus:ring-blue-500/20"
            />
          </div>
          <button @click="cancelSearch()" class="text-slate-500 font-bold px-2">
            Zrušit
          </button>
        </div>

        <div class="flex-grow overflow-y-auto scroller p-2">
          <template x-for="(result, idx) in results" :key="result.item.id">
            <button
              @click="addToRecipe(result.item)"
              class="w-full text-left p-4 rounded-xl border-b last:border-0 border-slate-50 flex justify-between items-center group transition"
              :class="idx === 0 ? 'bg-blue-50 border-blue-100 ring-1 ring-blue-200' : 'hover:bg-slate-50'"
            >
              <div>
                <span
                  class="block font-bold text-lg"
                  :class="idx === 0 ? 'text-blue-700' : 'text-slate-800'"
                  x-text="result.item.name"
                ></span>
                <span
                  class="text-sm text-slate-400"
                  x-text="'Balení: ' + result.item.package_size"
                ></span>
              </div>
              <div class="text-right">
                <span
                  class="text-xs font-bold uppercase tracking-wider text-slate-400 block mb-1"
                  x-show="idx === 0"
                  >Enter</span
                >
                <span
                  class="block font-mono font-bold text-slate-600"
                  x-text="formatCurrency(result.item.price_per_unit * (result.item.unit === 'g' || result.item.unit === 'ml' ? 100 : 1)) + (result.item.unit === 'ks' ? '/ks' : '/100' + result.item.unit)"
                ></span>
              </div>
            </button>
          </template>

          <div
            x-show="results.length === 0 && searchQuery !== ''"
            class="p-8 text-center text-slate-400"
          >
            Žádné výsledky.
          </div>
        </div>
      </div>

      <div
        x-show="numpadOpen"
        x-cloak
        class="fixed inset-0 z-[150] bg-slate-900/40 backdrop-blur-sm flex items-end sm:items-center justify-center"
        @click.self="numpadConfirm()"
      >
        <div
          x-show="numpadOpen"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="translate-y-full sm:opacity-0 sm:scale-95"
          class="bg-white w-full sm:w-[400px] sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden"
        >
          <div
            class="bg-slate-100 p-4 border-b border-slate-200 flex justify-between items-center"
          >
            <span class="text-sm font-bold text-slate-500 uppercase"
              >Množství</span
            >
            <div
              class="text-3xl font-mono font-bold text-slate-800"
              x-text="numpadValue || '0'"
            ></div>
            <span
              class="text-sm font-bold text-slate-400"
              x-text="activeRowIndex !== null && recipe[activeRowIndex] ? recipe[activeRowIndex].unit : ''"
            ></span>
          </div>

          <div class="grid grid-cols-3 gap-px bg-slate-200 p-px">
            <template x-for="num in [1,2,3,4,5,6,7,8,9]">
              <button
                @click="numpadPress(num)"
                class="bg-white hover:bg-slate-50 active:bg-blue-50 py-5 text-2xl font-bold text-slate-700 transition"
                x-text="num"
              ></button>
            </template>
            <button
              @click="numpadPress('.')"
              class="bg-white hover:bg-slate-50 py-5 text-2xl font-bold text-slate-700"
            >
              .
            </button>
            <button
              @click="numpadPress(0)"
              class="bg-white hover:bg-slate-50 py-5 text-2xl font-bold text-slate-700"
            >
              0
            </button>
            <button
              @click="numpadDelete()"
              class="bg-white hover:bg-red-50 text-red-500 py-5 flex items-center justify-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z"
                />
              </svg>
            </button>
          </div>

          <div class="p-4 bg-white border-t border-slate-100">
            <button
              @click="numpadConfirm()"
              class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-blue-700 active:transform active:scale-95 transition"
            >
              Hotovo
            </button>
          </div>
        </div>
      </div>

      <div
        x-show="toastVisible"
        x-cloak
        x-transition:enter="toast-enter-active"
        x-transition:enter-start="toast-enter"
        x-transition:enter-end="toast-exit"
        x-transition:leave="toast-exit-active"
        x-transition:leave-start="toast-exit"
        x-transition:leave-end="toast-enter"
        class="fixed bottom-20 left-6 right-6 z-[200] flex justify-center pointer-events-none"
      >
        <div
          class="bg-slate-900/90 backdrop-blur text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 pointer-events-auto"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 text-green-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            />
          </svg>
          <span class="font-bold text-sm" x-text="toastMessage"></span>
        </div>
      </div>
    </div>

    <script>
      function bakeryApp() {
        return {
          view: "calculator",
          ingredients: [],
          savedRecipes: [],

          // Search State (NEW)
          searchOpen: false,
          searchQuery: "",
          results: [],

          // Recipe State
          recipe: [],
          currentRecipeName: "",
          portionCount: 1,

          // Numpad State
          numpadOpen: false,
          numpadValue: "",
          activeRowIndex: null,

          // Manager State
          managerSearch: "",
          showRecipeList: false,
          fuse: null,

          // Toast State
          toastVisible: false,
          toastMessage: "",
          toastTimeout: null,

          async initApp() {
            try {
              // 1. Load Ingredients
              const savedData = localStorage.getItem("bakery_ingredients");
              if (savedData) {
                this.ingredients = JSON.parse(savedData);
              } else {
                await this.loadFromSource();
              }

              // 2. Load Saved Recipes
              const savedRecs = localStorage.getItem("bakery_saved_recipes");
              if (savedRecs) {
                this.savedRecipes = JSON.parse(savedRecs);
              }

              this.initFuse();
            } catch (error) {
              console.error("Error:", error);
            }
          },

          async loadFromSource() {
            const response = await fetch("./ingredients.json");
            this.ingredients = await response.json();
          },

          /* --- UX HELPERS --- */

          showToast(message) {
            this.toastMessage = message;
            this.toastVisible = true;

            if (this.toastTimeout) clearTimeout(this.toastTimeout);
            this.toastTimeout = setTimeout(() => {
              this.toastVisible = false;
            }, 3000);
          },

          /* --- SEARCH MODAL LOGIC (NEW) --- */

          initFuse() {
            const options = { keys: ["name", "search_term"], threshold: 0.3 };
            this.fuse = new Fuse(this.ingredients, options);
          },

          startSearch() {
            this.searchOpen = true;
            this.searchQuery = "";
            this.results = [];
            this.$nextTick(() => {
              this.$refs.searchInput.focus();
            });
          },

          performSearch() {
            if (!this.searchQuery) {
              this.results = [];
              return;
            }
            this.results = this.fuse.search(this.searchQuery);
          },

          selectTopResult() {
            if (this.results.length > 0) {
              this.addToRecipe(this.results[0].item);
            }
          },

          cancelSearch() {
            this.searchOpen = false;
            this.searchQuery = "";
            this.results = [];
          },

          addToRecipe(item) {
            this.recipe.push({ ...item, quantity: 0 });

            // Close search
            this.cancelSearch();

            // Auto-open NUMPAD for the last item
            this.$nextTick(() => {
              this.openNumpad(this.recipe.length - 1);
            });
          },

          /* --- NUMPAD HELPERS --- */

          openNumpad(index) {
            this.activeRowIndex = index;
            const currentVal = this.recipe[index].quantity;
            this.numpadValue = currentVal === 0 ? "" : String(currentVal);
            this.numpadOpen = true;
          },

          numpadPress(key) {
            if (key === ".") {
              if (this.numpadValue.includes(".")) return;
              if (this.numpadValue === "") this.numpadValue = "0";
            }
            this.numpadValue += key;
          },

          numpadDelete() {
            this.numpadValue = this.numpadValue.slice(0, -1);
          },

          numpadConfirm() {
            if (this.activeRowIndex !== null) {
              this.recipe[this.activeRowIndex].quantity =
                parseFloat(this.numpadValue) || 0;
            }
            this.numpadOpen = false;
            this.activeRowIndex = null;
          },

          /* --- RECIPE MANAGEMENT --- */

          saveRecipe() {
            if (this.recipe.length === 0) {
              this.showToast("Nelze uložit prázdný recept.");
              return;
            }
            if (!this.currentRecipeName) {
              this.showToast("Zadejte prosím název receptu.");
              return;
            }

            const newRecipe = {
              id: Date.now(),
              name: this.currentRecipeName,
              items: JSON.parse(JSON.stringify(this.recipe)), // Deep copy
              portionCount: this.portionCount,
            };

            this.savedRecipes.push(newRecipe);
            this.saveRecipesToStorage();
            this.showToast("Recept uložen!");
          },

          loadRecipe(savedItem) {
            if (this.recipe.length > 0) {
              if (
                !confirm(
                  "Aktuální rozpracovaný recept bude přepsán. Pokračovat?"
                )
              )
                return;
            }

            let loadedItems = JSON.parse(JSON.stringify(savedItem.items));

            loadedItems = loadedItems.map((recipeItem) => {
              const masterItem = this.ingredients.find(
                (i) => i.id === recipeItem.id
              );
              if (masterItem) {
                recipeItem.price_per_unit = masterItem.price_per_unit;
                recipeItem.package_price = masterItem.package_price;
              }
              return recipeItem;
            });

            this.recipe = loadedItems;
            this.currentRecipeName = savedItem.name;
            this.portionCount = savedItem.portionCount || 1;
            this.showRecipeList = false;
            this.showToast("Recept načten");
            this.cancelSearch();
          },

          deleteRecipe(index) {
            if (!confirm("Opravdu smazat tento recept?")) return;
            this.savedRecipes.splice(index, 1);
            this.saveRecipesToStorage();
            this.showToast("Recept smazán");
          },

          saveRecipesToStorage() {
            localStorage.setItem(
              "bakery_saved_recipes",
              JSON.stringify(this.savedRecipes)
            );
          },

          /* --- INGREDIENT MANAGEMENT --- */

          async resetToDefaults() {
            if (!confirm("Opravdu obnovit ceny ze serveru?")) return;
            localStorage.removeItem("bakery_ingredients");
            await this.loadFromSource();
            this.initFuse();
            this.showToast("Ceny obnoveny");
          },

          getNumericSize(item) {
            return parseFloat(item.package_size) || 0;
          },

          getBenchmarkPrice(item) {
            const size = this.getNumericSize(item);
            const price = parseFloat(item.package_price) || 0;

            if (!size || !price) return "---";

            if (item.unit === "ks") {
              return this.formatCurrency(price / size) + " / ks";
            }

            const pricePerUnit = price / size;
            const pricePer100 = pricePerUnit * 100;

            return this.formatCurrency(pricePer100) + " / 100" + item.unit;
          },

          updateItemDetails(item, field, value) {
            if (field === "package_size_val") {
              const currentUnit =
                item.package_size.replace(/[0-9.]/g, "") || item.unit;
              item.package_size = value + currentUnit;
            } else if (field === "unit") {
              const currentVal = parseFloat(item.package_size) || 0;
              item.unit = value;
              item.package_size = currentVal + value;
            } else {
              item[field] = value;
            }

            const sizeVal = parseFloat(item.package_size) || 1;
            item.price_per_unit = item.package_price / sizeVal;

            localStorage.setItem(
              "bakery_ingredients",
              JSON.stringify(this.ingredients)
            );

            this.initFuse();
          },

          downloadJson() {
            const dataStr =
              "data:text/json;charset=utf-8," +
              encodeURIComponent(JSON.stringify(this.ingredients, null, 2));
            const el = document.createElement("a");
            el.setAttribute("href", dataStr);
            el.setAttribute("download", "ingredients_updated.json");
            document.body.appendChild(el);
            el.click();
            el.remove();
          },

          /* --- REMOVE OLD SEARCH --- */

          checkBlur(event) {
            // No longer needed
          },

          removeRow(index) {
            this.recipe.splice(index, 1);
          },

          get filteredIngredients() {
            if (!this.managerSearch) return this.ingredients;
            return this.ingredients.filter((i) =>
              i.name.toLowerCase().includes(this.managerSearch.toLowerCase())
            );
          },

          get totalBatchCost() {
            return this.recipe.reduce(
              (sum, item) => sum + item.quantity * item.price_per_unit,
              0
            );
          },

          get pricePerPortion() {
            return this.portionCount > 0
              ? this.totalBatchCost / this.portionCount
              : 0;
          },

          formatCurrency(value) {
            if (isNaN(value)) return "0,00 Kč";
            return new Intl.NumberFormat("cs-CZ", {
              style: "currency",
              currency: "CZK",
            }).format(value);
          },
        };
      }
    </script>
    <script>
      // Register Service Worker for PWA
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js").then(() => {
          console.log("Service Worker Registered");
        });
      }
    </script>
  </body>
</html>
