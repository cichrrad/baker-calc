<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Bakery Cost Estimator</title>

    <link rel="manifest" href="manifest.json" />

    <link rel="apple-touch-icon" href="icon-192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#0f172a" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class", // Manually toggle dark mode via class
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"
    ></script>

    <style>
      .scroller {
        -webkit-overflow-scrolling: touch;
      }
      [x-cloak] {
        display: none !important;
      }
      /* Hide arrows in number inputs */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }

      /* Toast Animation */
      .toast-enter {
        opacity: 0;
        transform: translateY(100%);
      }
      .toast-enter-active {
        opacity: 1;
        transform: translateY(0);
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .toast-exit {
        opacity: 1;
        transform: translateY(0);
      }
      .toast-exit-active {
        opacity: 0;
        transform: translateY(100%);
        transition: all 0.3s ease-in;
      }
    </style>
  </head>
  <body
    class="bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-200 font-sans antialiased transition-colors duration-300 min-h-screen"
  >
    <div
      x-data="bakeryApp()"
      x-init="initApp()"
      class="max-w-3xl mx-auto min-h-screen flex flex-col relative"
    >
      <header
        class="p-4 mb-2 flex justify-between items-center sticky top-0 bg-slate-50/95 dark:bg-slate-950/95 backdrop-blur z-20 transition-colors duration-300"
      >
        <div class="flex-grow mr-4">
          <input
            type="text"
            x-show="view === 'calculator'"
            x-model="currentRecipeName"
            placeholder="Název Receptu..."
            class="w-full bg-transparent text-2xl sm:text-3xl font-bold text-slate-900 dark:text-slate-100 placeholder-slate-300 dark:placeholder-slate-600 border-none outline-none focus:ring-0 p-0 transition-colors"
          />
          <h1
            x-show="view === 'ingredients'"
            class="text-3xl font-bold text-slate-900 dark:text-slate-100"
          >
            Sklad
          </h1>
        </div>

        <div class="flex items-center gap-2">
          <button
            @click="toggleTheme()"
            class="p-2 rounded-lg text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-800 transition"
          >
            <svg
              x-show="darkMode"
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-amber-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
              />
            </svg>
            <svg
              x-show="!darkMode"
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-slate-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
              />
            </svg>
          </button>

          <button
            @click="view = (view === 'calculator' ? 'ingredients' : 'calculator')"
            class="px-4 py-2 rounded-lg font-bold text-sm transition flex items-center gap-2 flex-shrink-0"
            :class="view === 'ingredients' 
              ? 'bg-slate-800 text-white dark:bg-blue-600' 
              : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 shadow-sm border border-slate-200 dark:border-slate-700'"
          >
            <span x-text="view === 'calculator' ? 'Sklad' : 'Zpět'"></span>
            <svg
              x-show="view === 'calculator'"
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"
              />
            </svg>
          </button>
        </div>
      </header>

      <div
        x-show="view === 'calculator'"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 translate-y-4"
        class="flex flex-col flex-grow px-4"
      >
        <section class="mb-4 flex gap-2">
          <button
            @click="saveRecipe()"
            class="bg-blue-600 dark:bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 dark:hover:bg-blue-500 transition shadow-sm flex-1 sm:flex-none"
          >
            Uložit
          </button>
          <button
            @click="showRecipeList = true"
            class="bg-white dark:bg-slate-800 text-blue-700 dark:text-blue-400 border border-blue-200 dark:border-slate-700 px-4 py-3 rounded-xl font-bold hover:bg-blue-50 dark:hover:bg-slate-700 transition shadow-sm flex items-center justify-center gap-2 flex-1 sm:flex-none"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
              />
            </svg>
            <span x-text="'Moje (' + savedRecipes.length + ')'"></span>
          </button>
        </section>

        <section
          class="flex-grow bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700/50 mb-4 pb-32 transition-colors"
        >
          <div
            class="hidden md:grid grid-cols-[1fr_auto_100px_50px] gap-4 p-4 bg-slate-100 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 uppercase text-xs font-bold rounded-t-xl"
          >
            <div>Surovina</div>
            <div>Množství</div>
            <div class="text-right">Cena</div>
            <div></div>
          </div>

          <div class="divide-y divide-slate-100 dark:divide-slate-700 relative">
            <div
              x-show="recipe.length === 0"
              class="p-12 text-center text-slate-400 italic"
            >
              Začněte přidáním první suroviny.
            </div>

            <template
              x-for="(row, index) in recipe"
              :key="row.id + '_' + index"
            >
              <div
                class="p-4 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition group flex flex-col md:grid md:grid-cols-[1fr_auto_100px_50px] md:items-center gap-2 md:gap-4"
              >
                <div
                  class="font-bold text-slate-800 dark:text-slate-200 text-lg md:text-base leading-tight"
                  x-text="row.name"
                ></div>

                <div class="flex items-center justify-between md:contents">
                  <div class="flex items-center">
                    <button
                      @click="openNumpad(index)"
                      class="w-20 p-2 border border-slate-300 dark:border-slate-600 rounded-lg text-center font-mono text-lg font-bold text-slate-800 dark:text-slate-200 bg-white dark:bg-slate-900 hover:border-blue-500 hover:text-blue-600 focus:ring-2 focus:ring-blue-100 transition"
                    >
                      <span x-text="row.quantity || '0'"></span>
                    </button>
                    <span
                      class="ml-2 text-slate-500 dark:text-slate-400 text-sm font-bold"
                      x-text="row.unit"
                    ></span>
                  </div>

                  <div
                    class="font-mono font-bold text-slate-700 dark:text-slate-300 text-right md:text-right"
                  >
                    <span
                      x-text="formatCurrency(row.quantity * row.price_per_unit)"
                    ></span>
                  </div>

                  <div class="text-right">
                    <button
                      @click="removeRow(index)"
                      class="text-slate-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition p-2"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"
                        />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </template>

            <div class="p-2 bg-slate-50/50 dark:bg-slate-800/50 rounded-b-xl">
              <button
                @click="startSearch()"
                class="w-full py-4 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl text-slate-400 dark:text-slate-500 font-bold hover:border-blue-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-slate-700 transition flex items-center justify-center gap-2 group"
              >
                <div
                  class="bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-400 rounded-full p-1 group-hover:bg-blue-200 dark:group-hover:bg-blue-900 group-hover:text-blue-600 dark:group-hover:text-blue-300 transition"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
                <span>Přidat surovinu</span>
              </button>
            </div>
          </div>
        </section>

        <footer
          class="fixed bottom-0 left-0 right-0 bg-slate-900 dark:bg-slate-950 text-white z-[40] shadow-[0_-5px_15px_rgba(0,0,0,0.3)] md:absolute md:bottom-6 md:left-4 md:right-4 md:rounded-2xl md:max-w-3xl md:mx-auto border-t border-slate-800 md:border-none"
        >
          <div class="md:hidden flex justify-between items-center p-4">
            <div class="flex flex-col">
              <span class="text-xs text-slate-400 uppercase tracking-wider"
                >Cena celkem</span
              >
              <span
                class="text-xl font-mono font-bold"
                x-text="formatCurrency(totalBatchCost)"
              ></span>
            </div>

            <div
              class="flex items-center gap-3 bg-slate-800 dark:bg-slate-900 rounded-lg p-1.5 pl-3 border border-slate-700"
            >
              <div class="flex flex-col text-right">
                <span class="text-[10px] text-slate-400">ks</span>
                <span
                  class="text-xs font-bold text-blue-300"
                  x-text="formatCurrency(pricePerPortion)"
                ></span>
              </div>
              <input
                type="number"
                inputmode="numeric"
                x-model.number="portionCount"
                class="w-12 h-10 bg-slate-700 dark:bg-slate-800 rounded text-center text-white font-mono font-bold focus:border-blue-400 border border-transparent outline-none"
              />
            </div>
          </div>

          <div class="hidden md:grid grid-cols-2 gap-6 items-center p-6">
            <div
              class="flex justify-between items-center border-r border-slate-700 pr-6"
            >
              <span class="text-slate-400 uppercase text-sm tracking-wider"
                >Cena za várku</span
              >
              <span
                class="text-2xl font-mono font-bold"
                x-text="formatCurrency(totalBatchCost)"
              ></span>
            </div>

            <div class="flex flex-col gap-4">
              <div class="flex justify-between items-center">
                <label class="text-slate-400 text-sm">Počet kusů</label>
                <input
                  type="number"
                  inputmode="numeric"
                  x-model.number="portionCount"
                  class="w-20 bg-slate-800 dark:bg-slate-900 border border-slate-600 rounded-lg text-center text-white p-2 font-mono focus:border-blue-400 outline-none"
                />
              </div>
              <div
                class="flex justify-between items-center bg-blue-600 dark:bg-blue-700 -mx-2 p-4 rounded-xl"
              >
                <span class="font-bold text-blue-100">Cena za 1 ks</span>
                <span
                  class="text-3xl font-bold font-mono"
                  x-text="formatCurrency(pricePerPortion)"
                ></span>
              </div>
            </div>
          </div>
        </footer>
      </div>

      <div
        x-show="view === 'ingredients'"
        x-cloak
        x-transition:enter="transition ease-out duration-200"
        class="flex-grow flex flex-col px-4"
      >
        <div class="mb-4 flex flex-col md:flex-row gap-3">
          <input
            type="text"
            x-model="managerSearch"
            placeholder="Hledat pro úpravu..."
            class="w-full md:flex-grow p-3 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-xl shadow-sm focus:border-blue-500 dark:text-white outline-none transition-colors"
          />

          <div class="flex gap-2 shrink-0">
            <button
              @click="openNewIngredientModal()"
              class="flex-1 md:flex-none bg-blue-600 text-white px-4 py-3 md:py-0 rounded-xl font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-sm whitespace-nowrap"
              title="Přidat surovinu"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                  clip-rule="evenodd"
                />
              </svg>
              <span>Nová</span>
            </button>

            <button
              @click="downloadJson()"
              class="bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 px-4 py-3 md:py-0 rounded-xl font-bold hover:bg-slate-300 dark:hover:bg-slate-600 transition"
              title="Stáhnout změny"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                />
              </svg>
            </button>

            <button
              @click="resetToDefaults()"
              class="bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 px-4 py-3 md:py-0 rounded-xl font-bold hover:bg-red-200 dark:hover:bg-red-900/50 transition"
              title="Obnovit výchozí"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-24">
          <template x-for="item in filteredIngredients" :key="item.id">
            <div
              class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm relative group transition-colors"
            >
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h3
                    class="font-bold text-lg text-slate-800 dark:text-slate-100 leading-tight"
                    x-text="item.name"
                  ></h3>
                  <span
                    class="text-xs font-bold uppercase tracking-wider text-slate-400"
                    x-text="item.category"
                  ></span>
                  <span
                    x-show="item.category === 'Vlastní'"
                    class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200"
                  >
                    Nový
                  </span>
                </div>
                <div
                  class="bg-blue-50 dark:bg-slate-700 text-blue-700 dark:text-blue-300 px-2 py-1 rounded text-xs font-bold font-mono border border-blue-100 dark:border-slate-600 whitespace-nowrap"
                >
                  <span x-text="getBenchmarkPrice(item)"></span>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-bold text-slate-400 mb-1"
                    >Cena balení</label
                  >
                  <div class="relative">
                    <input
                      type="number"
                      inputmode="decimal"
                      step="0.1"
                      x-model.number="item.package_price"
                      @input="updateItemDetails(item, 'package_price', $el.value)"
                      class="w-full pl-2 pr-8 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg font-mono font-bold text-slate-700 dark:text-slate-200 focus:bg-white dark:focus:bg-slate-950 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 outline-none transition"
                    />
                    <span class="absolute right-3 top-2 text-slate-400 text-sm"
                      >Kč</span
                    >
                  </div>
                </div>

                <div>
                  <label class="block text-xs font-bold text-slate-400 mb-1"
                    >Velikost</label
                  >
                  <div class="flex rounded-lg shadow-sm">
                    <input
                      type="number"
                      inputmode="decimal"
                      step="any"
                      :value="parseFloat(item.package_size)"
                      @input="updateItemDetails(item, 'package_size_val', $el.value)"
                      class="w-full min-w-0 px-2 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-l-lg font-mono text-slate-700 dark:text-slate-200 focus:bg-white dark:focus:bg-slate-950 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 outline-none transition z-10"
                    />
                    <select
                      x-model="item.unit"
                      @change="updateItemDetails(item, 'unit', $el.value)"
                      class="bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 border-y border-r border-slate-200 dark:border-slate-600 rounded-r-lg px-2 text-sm font-bold outline-none cursor-pointer transition"
                    >
                      <option value="g">g</option>
                      <option value="ml">ml</option>
                      <option value="ks">ks</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <div
        x-show="newIngredientModalOpen"
        x-cloak
        class="fixed inset-0 z-[150] bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4"
      >
        <div
          @click.away="newIngredientModalOpen = false"
          class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col transition-colors"
        >
          <div
            class="bg-slate-100 dark:bg-slate-900 p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center"
          >
            <h3 class="font-bold text-lg text-slate-800 dark:text-white">
              Nová surovina
            </h3>
            <button
              @click="newIngredientModalOpen = false"
              class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <div class="p-4 pb-0">
            <div
              class="bg-slate-100 dark:bg-slate-700 p-1 rounded-xl flex font-bold text-sm"
            >
              <button
                @click="switchNewIngredientMode('manual')"
                class="flex-1 py-2 rounded-lg transition"
                :class="newIngredientMode === 'manual' 
                  ? 'bg-white dark:bg-slate-600 text-blue-600 dark:text-blue-300 shadow-sm' 
                  : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'"
              >
                Ručně
              </button>
              <button
                @click="switchNewIngredientMode('rohlik')"
                class="flex-1 py-2 rounded-lg transition"
                :class="newIngredientMode === 'rohlik' 
                  ? 'bg-white dark:bg-slate-600 text-green-600 dark:text-green-300 shadow-sm' 
                  : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'"
              >
                Z odkazu (Rohlik)
              </button>
            </div>
          </div>

          <div class="p-4 space-y-4">
            <div x-show="newIngredientMode === 'rohlik'">
              <label class="block text-xs font-bold text-slate-400 mb-1"
                >Odkaz na produkt (Rohlik.cz)</label
              >
              <input
                type="text"
                x-model="newIngredientForm.url"
                @paste="handleRohlikPaste($event)"
                placeholder="https://www.rohlik.cz/..."
                class="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl focus:border-green-500 outline-none text-sm dark:text-white"
              />
              <p class="text-[10px] text-slate-400 mt-1">
                Vložte odkaz a my zkusíme načíst data.
              </p>
            </div>

            <div>
              <label class="block text-xs font-bold text-slate-400 mb-1"
                >Název</label
              >
              <input
                type="text"
                x-model="newIngredientForm.name"
                placeholder="Např. Specifická Mouka"
                class="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl focus:border-blue-500 outline-none font-bold text-slate-800 dark:text-white"
              />
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-bold text-slate-400 mb-1"
                  >Cena (Kč)</label
                >
                <input
                  type="number"
                  inputmode="decimal"
                  x-model.number="newIngredientForm.price"
                  class="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl focus:border-blue-500 outline-none font-mono font-bold dark:text-white"
                />
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-400 mb-1"
                  >Velikost</label
                >
                <div class="flex rounded-xl shadow-sm">
                  <input
                    type="number"
                    inputmode="decimal"
                    x-model.number="newIngredientForm.size"
                    class="w-full min-w-0 p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-l-xl focus:border-blue-500 outline-none font-mono font-bold dark:text-white"
                  />
                  <select
                    x-model="newIngredientForm.unit"
                    class="bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 border-y border-r border-slate-200 dark:border-slate-700 rounded-r-xl px-2 text-sm font-bold outline-none"
                  >
                    <option value="g">g</option>
                    <option value="ml">ml</option>
                    <option value="ks">ks</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-2 text-xs text-slate-400">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <span>Bude uloženo do kategorie <strong>Vlastní</strong></span>
            </div>
          </div>

          <div
            class="p-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800"
          >
            <button
              @click="saveNewIngredient()"
              :disabled="!newIngredientForm.name || !newIngredientForm.price"
              class="w-full py-3 rounded-xl font-bold text-lg shadow-sm transition disabled:opacity-50 disabled:cursor-not-allowed"
              :class="newIngredientMode === 'rohlik' ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'"
            >
              Uložit surovinu
            </button>
          </div>
        </div>
      </div>

      <div
        x-show="showRecipeList"
        x-cloak
        class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm"
      >
        <div
          @click.away="showRecipeList = false"
          class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh] transition-colors"
        >
          <div
            class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900"
          >
            <h2 class="text-xl font-bold text-slate-800 dark:text-white">
              Uložené recepty
            </h2>
            <button
              @click="showRecipeList = false"
              class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <div class="overflow-y-auto p-4 scroller">
            <div
              x-show="savedRecipes.length === 0"
              class="text-center py-12 text-slate-400"
            >
              <p class="italic">Zatím nemáte žádné uložené recepty.</p>
            </div>

            <div class="space-y-3">
              <template x-for="(saved, index) in savedRecipes" :key="saved.id">
                <div
                  class="flex items-center justify-between p-4 border border-slate-200 dark:border-slate-700 rounded-xl hover:border-blue-300 dark:hover:border-blue-500 transition group bg-white dark:bg-slate-700"
                >
                  <div>
                    <h3
                      class="font-bold text-lg text-slate-800 dark:text-white"
                      x-text="saved.name"
                    ></h3>
                    <p
                      class="text-xs text-slate-400 dark:text-slate-300"
                      x-text="'Položek: ' + saved.items.length"
                    ></p>
                  </div>
                  <div class="flex items-center gap-2">
                    <button
                      @click="loadRecipe(saved)"
                      class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200 px-3 py-2 rounded-lg font-bold text-sm hover:bg-blue-200 dark:hover:bg-blue-800 transition"
                    >
                      Načíst
                    </button>
                    <button
                      @click="deleteRecipe(index)"
                      class="text-slate-300 hover:text-red-500 p-2 transition"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                        />
                      </svg>
                    </button>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <div
        x-show="searchOpen"
        x-cloak
        class="fixed inset-0 z-[200] bg-white dark:bg-slate-900 flex flex-col transition-colors"
      >
        <div
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center gap-3"
        >
          <div class="relative flex-grow">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
            <input
              x-ref="searchInput"
              type="text"
              x-model="searchQuery"
              @input="performSearch()"
              @keydown.escape="cancelSearch()"
              @keydown.enter.prevent="selectTopResult()"
              placeholder="Hledat surovinu..."
              class="w-full pl-10 pr-4 py-3 bg-slate-100 dark:bg-slate-800 border-none rounded-xl text-lg font-bold text-slate-800 dark:text-white placeholder-slate-400 outline-none focus:ring-2 focus:ring-blue-500/20"
            />
          </div>
          <button @click="cancelSearch()" class="text-slate-500 font-bold px-2">
            Zrušit
          </button>
        </div>

        <div class="flex-grow overflow-y-auto scroller p-2">
          <template x-for="(result, idx) in results" :key="result.item.id">
            <button
              @click="addToRecipe(result.item)"
              class="w-full text-left p-4 rounded-xl border-b last:border-0 border-slate-50 dark:border-slate-800 flex justify-between items-center group transition"
              :class="idx === 0 
                ? 'bg-blue-50 dark:bg-blue-900/30 border-blue-100 dark:border-blue-800 ring-1 ring-blue-200 dark:ring-blue-800' 
                : 'hover:bg-slate-50 dark:hover:bg-slate-800'"
            >
              <div>
                <span
                  class="block font-bold text-lg"
                  :class="idx === 0 ? 'text-blue-700 dark:text-blue-300' : 'text-slate-800 dark:text-slate-200'"
                  x-text="result.item.name"
                ></span>
                <span
                  class="text-sm text-slate-400"
                  x-text="'Balení: ' + result.item.package_size"
                ></span>
              </div>
              <div class="text-right">
                <span
                  class="text-xs font-bold uppercase tracking-wider text-slate-400 block mb-1"
                  x-show="idx === 0"
                  >Enter</span
                >
                <span
                  class="block font-mono font-bold text-slate-600 dark:text-slate-400"
                  x-text="formatCurrency(result.item.price_per_unit * (result.item.unit === 'g' || result.item.unit === 'ml' ? 100 : 1)) + (result.item.unit === 'ks' ? '/ks' : '/100' + result.item.unit)"
                ></span>
              </div>
            </button>
          </template>

          <div
            x-show="results.length === 0 && searchQuery !== ''"
            class="p-8 text-center text-slate-400"
          >
            Žádné výsledky.
          </div>
        </div>
      </div>

      <div
        x-show="numpadOpen"
        x-cloak
        class="fixed inset-0 z-[150] bg-slate-900/40 backdrop-blur-sm flex items-end sm:items-center justify-center"
        @click.self="numpadConfirm()"
      >
        <div
          x-show="numpadOpen"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="translate-y-full sm:opacity-0 sm:scale-95"
          class="bg-white dark:bg-slate-800 w-full sm:w-[400px] sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden transition-colors"
        >
          <div
            class="bg-slate-100 dark:bg-slate-900 p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center"
          >
            <span class="text-sm font-bold text-slate-500 uppercase"
              >Množství</span
            >
            <div
              class="text-3xl font-mono font-bold text-slate-800 dark:text-white"
              x-text="numpadValue || '0'"
            ></div>
            <span
              class="text-sm font-bold text-slate-400"
              x-text="activeRowIndex !== null && recipe[activeRowIndex] ? recipe[activeRowIndex].unit : ''"
            ></span>
          </div>

          <div
            class="grid grid-cols-3 gap-px bg-slate-200 dark:bg-slate-700 p-px"
          >
            <template x-for="num in [1,2,3,4,5,6,7,8,9]">
              <button
                @click="numpadPress(num)"
                class="bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 active:bg-blue-50 dark:active:bg-blue-900/30 py-5 text-2xl font-bold text-slate-700 dark:text-slate-200 transition"
                x-text="num"
              ></button>
            </template>
            <button
              @click="numpadPress('.')"
              class="bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 py-5 text-2xl font-bold text-slate-700 dark:text-slate-200"
            >
              .
            </button>
            <button
              @click="numpadPress(0)"
              class="bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 py-5 text-2xl font-bold text-slate-700 dark:text-slate-200"
            >
              0
            </button>
            <button
              @click="numpadDelete()"
              class="bg-white dark:bg-slate-800 hover:bg-red-50 dark:hover:bg-red-900/30 text-red-500 py-5 flex items-center justify-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z"
                />
              </svg>
            </button>
          </div>

          <div
            class="p-4 bg-white dark:bg-slate-800 border-t border-slate-100 dark:border-slate-700"
          >
            <button
              @click="numpadConfirm()"
              class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-blue-700 active:transform active:scale-95 transition"
            >
              Hotovo
            </button>
          </div>
        </div>
      </div>

      <div
        x-show="toastVisible"
        x-cloak
        x-transition:enter="toast-enter-active"
        x-transition:enter-start="toast-enter"
        x-transition:enter-end="toast-exit"
        x-transition:leave="toast-exit-active"
        x-transition:leave-start="toast-exit"
        x-transition:leave-end="toast-enter"
        class="fixed bottom-20 left-6 right-6 z-[200] flex justify-center pointer-events-none"
      >
        <div
          class="bg-slate-900/90 dark:bg-slate-100/90 backdrop-blur text-white dark:text-slate-900 px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 pointer-events-auto"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 text-green-400 dark:text-green-600"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            />
          </svg>
          <span class="font-bold text-sm" x-text="toastMessage"></span>
        </div>
      </div>
    </div>

    <script>
      function bakeryApp() {
        return {
          // --- State ---
          view: "calculator",
          darkMode: false, // New State for Theme
          ingredients: [],
          savedRecipes: [],

          // Search State
          searchOpen: false,
          searchQuery: "",
          results: [],

          // Recipe State
          recipe: [],
          currentRecipeName: "",
          portionCount: 1,

          // Numpad State
          numpadOpen: false,
          numpadValue: "",
          activeRowIndex: null,

          // Manager State
          managerSearch: "",
          showRecipeList: false,
          fuse: null,

          // New Ingredient State
          newIngredientModalOpen: false,
          newIngredientMode: "manual",
          newIngredientForm: {
            name: "",
            price: "",
            size: "",
            unit: "g",
            url: "",
            rohlik_id: null,
          },

          // Toast State
          toastVisible: false,
          toastMessage: "",
          toastTimeout: null,

          // --- Initialization ---
          async initApp() {
            // Wake Lock
            if ("wakeLock" in navigator) {
              try {
                const wakeLock = await navigator.wakeLock.request("screen");
                console.log("Screen Wake Lock active");
              } catch (err) {
                console.error(`${err.name}, ${err.message}`);
              }
            }

            // Load Theme Preference
            const savedTheme = localStorage.getItem("bakery_theme");
            if (
              savedTheme === "dark" ||
              (!savedTheme &&
                window.matchMedia("(prefers-color-scheme: dark)").matches)
            ) {
              this.darkMode = true;
              document.documentElement.classList.add("dark"); // <--- ADDS TO HTML TAG
            } else {
              this.darkMode = false;
              document.documentElement.classList.remove("dark");
            }

            // Load Data
            try {
              const savedData = localStorage.getItem("bakery_ingredients");
              if (savedData) {
                this.ingredients = JSON.parse(savedData);
              } else {
                await this.loadFromSource();
              }

              const savedRecs = localStorage.getItem("bakery_saved_recipes");
              if (savedRecs) {
                this.savedRecipes = JSON.parse(savedRecs);
              }

              this.initFuse();
            } catch (error) {
              console.error("Error:", error);
            }
          },

          async loadFromSource() {
            const response = await fetch("./ingredients.json");
            this.ingredients = await response.json();
          },

          // --- Theme Logic ---
          toggleTheme() {
            this.darkMode = !this.darkMode;
            localStorage.setItem(
              "bakery_theme",
              this.darkMode ? "dark" : "light"
            );

            // Manually toggle the class on the HTML tag
            if (this.darkMode) {
              document.documentElement.classList.add("dark");
            } else {
              document.documentElement.classList.remove("dark");
            }
          },

          /* --- NEW INGREDIENT LOGIC --- */
          openNewIngredientModal() {
            this.newIngredientForm = {
              name: "",
              price: "",
              size: "",
              unit: "g",
              url: "",
              rohlik_id: null,
            };
            this.newIngredientMode = "manual";
            this.newIngredientModalOpen = true;
          },

          switchNewIngredientMode(mode) {
            this.newIngredientMode = mode;
          },

          async handleRohlikPaste(event) {
            await this.$nextTick();
            const url = this.newIngredientForm.url;
            const idMatch = url.match(/(\d{6,})/);
            if (!idMatch) return;

            const id = idMatch[1];
            this.newIngredientForm.rohlik_id = id;
            this.showToast("ID nalezeno: " + id);

            try {
              this.showToast("Načítám data...");
              const response = await fetch(
                `https://www.rohlik.cz/api/v1/products/prices?products=${id}`
              );
              const data = await response.json();
              if (data && data.length > 0) {
                const product = data[0];
                if (product.price)
                  this.newIngredientForm.price = product.price.amount;
                this.showToast("Cena načtena!");
              }
            } catch (e) {
              console.log("CORS prevented fetch");
              this.showToast("Data nelze stáhnout automaticky (CORS).");
            }
          },

          saveNewIngredient() {
            const isRohlik = this.newIngredientMode === "rohlik";
            const price = parseFloat(this.newIngredientForm.price);

            if (isNaN(price)) {
              this.showToast("Cena musí být číslo!");
              return;
            }

            const newItem = {
              id: "temp_" + Date.now(),
              category: "Vlastní",
              name: this.newIngredientForm.name,
              unit: this.newIngredientForm.unit,
              source: isRohlik ? "rohlik" : "manual",
              rohlik_id: isRohlik ? this.newIngredientForm.rohlik_id : null,
              rohlik_url: isRohlik ? this.newIngredientForm.url : null,
              search_term: this.newIngredientForm.name,
              package_price: price,
              package_size:
                this.newIngredientForm.size + this.newIngredientForm.unit,
              price_per_unit: 0,
              auto_price: null,
            };

            const sizeVal = parseFloat(this.newIngredientForm.size);
            if (sizeVal > 0) {
              newItem.price_per_unit = newItem.package_price / sizeVal;
            }

            this.ingredients.push(newItem);
            localStorage.setItem(
              "bakery_ingredients",
              JSON.stringify(this.ingredients)
            );
            this.initFuse();
            this.newIngredientModalOpen = false;
            this.showToast("Surovina uložena!");
          },

          /* --- UX HELPERS --- */
          showToast(message) {
            this.toastMessage = message;
            this.toastVisible = true;
            if (this.toastTimeout) clearTimeout(this.toastTimeout);
            this.toastTimeout = setTimeout(() => {
              this.toastVisible = false;
            }, 3000);
          },

          /* --- SEARCH LOGIC --- */
          initFuse() {
            const options = { keys: ["name", "search_term"], threshold: 0.3 };
            this.fuse = new Fuse(this.ingredients, options);
          },

          startSearch() {
            this.searchOpen = true;
            this.searchQuery = "";
            this.results = [];
            this.$nextTick(() => {
              this.$refs.searchInput.focus();
            });
          },

          performSearch() {
            if (!this.searchQuery) {
              this.results = [];
              return;
            }
            this.results = this.fuse.search(this.searchQuery);
          },

          selectTopResult() {
            if (this.results.length > 0) {
              this.addToRecipe(this.results[0].item);
            }
          },

          cancelSearch() {
            this.searchOpen = false;
            this.searchQuery = "";
            this.results = [];
          },

          addToRecipe(item) {
            this.recipe.push({ ...item, quantity: 0 });
            this.cancelSearch();
            this.$nextTick(() => {
              this.openNumpad(this.recipe.length - 1);
            });
          },

          /* --- NUMPAD HELPERS --- */
          openNumpad(index) {
            this.activeRowIndex = index;
            const currentVal = this.recipe[index].quantity;
            this.numpadValue = currentVal === 0 ? "" : String(currentVal);
            this.numpadOpen = true;
          },

          numpadPress(key) {
            if (key === ".") {
              if (
                this.numpadValue.includes(".") ||
                this.numpadValue.includes(",")
              )
                return;
              if (this.numpadValue === "") {
                this.numpadValue = "0.";
                return;
              }
            }
            this.numpadValue += key;
          },

          numpadDelete() {
            this.numpadValue = this.numpadValue.slice(0, -1);
          },

          numpadConfirm() {
            if (this.activeRowIndex !== null) {
              this.recipe[this.activeRowIndex].quantity =
                parseFloat(this.numpadValue) || 0;
            }
            this.numpadOpen = false;
            this.activeRowIndex = null;
          },

          /* --- RECIPE MANAGEMENT --- */
          saveRecipe() {
            if (this.recipe.length === 0) {
              this.showToast("Nelze uložit prázdný recept.");
              return;
            }
            if (!this.currentRecipeName) {
              this.showToast("Zadejte prosím název receptu.");
              return;
            }

            const newRecipe = {
              id: Date.now(),
              name: this.currentRecipeName,
              items: JSON.parse(JSON.stringify(this.recipe)),
              portionCount: this.portionCount,
            };

            this.savedRecipes.push(newRecipe);
            this.saveRecipesToStorage();
            this.showToast("Recept uložen!");
          },

          loadRecipe(savedItem) {
            if (this.recipe.length > 0) {
              if (
                !confirm(
                  "Aktuální rozpracovaný recept bude přepsán. Pokračovat?"
                )
              )
                return;
            }

            let loadedItems = JSON.parse(JSON.stringify(savedItem.items));
            loadedItems = loadedItems.map((recipeItem) => {
              const masterItem = this.ingredients.find(
                (i) => i.id === recipeItem.id
              );
              if (masterItem) {
                recipeItem.price_per_unit = masterItem.price_per_unit;
                recipeItem.package_price = masterItem.package_price;
              }
              return recipeItem;
            });

            this.recipe = loadedItems;
            this.currentRecipeName = savedItem.name;
            this.portionCount = savedItem.portionCount || 1;
            this.showRecipeList = false;
            this.showToast("Recept načten");
            this.cancelSearch();
          },

          deleteRecipe(index) {
            if (!confirm("Opravdu smazat tento recept?")) return;
            this.savedRecipes.splice(index, 1);
            this.saveRecipesToStorage();
            this.showToast("Recept smazán");
          },

          saveRecipesToStorage() {
            localStorage.setItem(
              "bakery_saved_recipes",
              JSON.stringify(this.savedRecipes)
            );
          },

          /* --- INGREDIENT MANAGEMENT --- */
          async resetToDefaults() {
            if (!confirm("Opravdu obnovit ceny ze serveru?")) return;
            localStorage.removeItem("bakery_ingredients");
            await this.loadFromSource();
            this.initFuse();
            this.showToast("Ceny obnoveny");
          },

          getNumericSize(item) {
            return parseFloat(item.package_size) || 0;
          },

          getBenchmarkPrice(item) {
            const size = this.getNumericSize(item);
            const price = parseFloat(item.package_price) || 0;

            if (!size || !price) return "---";

            if (item.unit === "ks") {
              return this.formatCurrency(price / size) + " / ks";
            }
            const pricePerUnit = price / size;
            const pricePer100 = pricePerUnit * 100;
            return this.formatCurrency(pricePer100) + " / 100" + item.unit;
          },

          updateItemDetails(item, field, value) {
            if (field === "package_size_val") {
              const currentUnit =
                item.package_size.replace(/[0-9.]/g, "") || item.unit;
              item.package_size = value + currentUnit;
            } else if (field === "unit") {
              const currentVal = parseFloat(item.package_size) || 0;
              item.unit = value;
              item.package_size = currentVal + value;
            } else {
              item[field] = value;
            }
            const sizeVal = parseFloat(item.package_size) || 1;
            item.price_per_unit = item.package_price / sizeVal;
            localStorage.setItem(
              "bakery_ingredients",
              JSON.stringify(this.ingredients)
            );
            this.initFuse();
          },

          downloadJson() {
            const dataStr =
              "data:text/json;charset=utf-8," +
              encodeURIComponent(JSON.stringify(this.ingredients, null, 2));
            const el = document.createElement("a");
            el.setAttribute("href", dataStr);
            el.setAttribute("download", "ingredients_updated.json");
            document.body.appendChild(el);
            el.click();
            el.remove();
          },

          /* --- COMPUTED --- */
          removeRow(index) {
            this.recipe.splice(index, 1);
          },

          get filteredIngredients() {
            if (!this.managerSearch) return this.ingredients;
            return this.ingredients.filter((i) =>
              i.name.toLowerCase().includes(this.managerSearch.toLowerCase())
            );
          },

          get totalBatchCost() {
            return this.recipe.reduce(
              (sum, item) => sum + item.quantity * item.price_per_unit,
              0
            );
          },

          get pricePerPortion() {
            return this.portionCount > 0
              ? this.totalBatchCost / this.portionCount
              : 0;
          },

          formatCurrency(value) {
            if (isNaN(value)) return "0,00 Kč";
            return new Intl.NumberFormat("cs-CZ", {
              style: "currency",
              currency: "CZK",
            }).format(value);
          },
        };
      }
    </script>
    <script>
      // Register Service Worker for PWA
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js").then(() => {
          console.log("Service Worker Registered");
        });
      }
    </script>
  </body>
</html>
